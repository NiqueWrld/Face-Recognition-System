<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Recognition - Face Recognition System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0ea5e9', // sky-500
                        secondary: '#0284c7' // sky-600
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-4">
                    <a href="/" class="flex items-center justify-center w-10 h-10 bg-primary rounded-lg hover:bg-secondary transition-colors">
                        <i class="fas fa-arrow-left text-xl text-white"></i>
                    </a>
                    <div>
                        <h1 class="text-xl font-bold text-slate-900">Live Face Recognition</h1>
                        <p class="text-sm text-slate-600 hidden sm:block">Real-time Detection & Analysis</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <span id="status" class="hidden sm:flex items-center px-3 py-1 rounded-full text-sm font-medium bg-slate-100 text-slate-600">
                        <i class="fas fa-circle text-slate-400 mr-2 animate-pulse"></i>
                        Initializing...
                    </span>
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-emerald-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-video text-white text-sm"></i>
                        </div>
                        <span class="text-sm font-medium text-slate-700 hidden sm:block">Live Camera</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Control Panel -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 mb-8">
            <div class="px-6 py-4 border-b border-slate-200">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                    <div class="flex items-center space-x-4">
                        <div id="camera-status" class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-slate-400 rounded-full animate-pulse"></div>
                            <span class="text-sm font-medium text-slate-600">Camera Ready</span>
                        </div>
                        <span id="fps-counter" class="text-sm text-slate-500 hidden">FPS: 0</span>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-3">
                        <button id="start-camera" class="inline-flex items-center px-4 py-2 bg-primary text-white font-medium rounded-lg hover:bg-secondary transition-colors shadow-sm">
                            <i class="fas fa-play mr-2"></i>
                            Start Camera
                        </button>
                        <button id="stop-camera" class="inline-flex items-center px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition-colors shadow-sm hidden">
                            <i class="fas fa-stop mr-2"></i>
                            Stop Camera
                        </button>
                        <button id="capture-frame" class="inline-flex items-center px-4 py-2 bg-emerald-600 text-white font-medium rounded-lg hover:bg-emerald-700 transition-colors shadow-sm hidden">
                            <i class="fas fa-camera mr-2"></i>
                            Capture
                        </button>
                        <a href="/" class="inline-flex items-center px-4 py-2 bg-slate-600 text-white font-medium rounded-lg hover:bg-slate-700 transition-colors shadow-sm">
                            <i class="fas fa-home mr-2"></i>
                            Home
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
            <!-- Camera Feed -->
            <div class="xl:col-span-3">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-900 flex items-center">
                            <i class="fas fa-video text-primary mr-2"></i>
                            Live Camera Feed
                        </h3>
                    </div>
                    
                    <div class="relative bg-slate-900" style="aspect-ratio: 16/9;">
                        <!-- Camera Placeholder -->
                        <div id="camera-placeholder" class="flex items-center justify-center h-full bg-slate-100">
                            <div class="text-center">
                                <div class="w-20 h-20 bg-slate-200 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <i class="fas fa-video text-4xl text-slate-400"></i>
                                </div>
                                <h4 class="text-xl font-semibold text-slate-900 mb-2">Camera View</h4>
                                <p class="text-slate-600 mb-6">Click "Start Camera" to begin face recognition</p>
                                <div class="flex items-center justify-center space-x-2 text-slate-500">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="text-sm">Ensure good lighting for best results</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Video Element -->
                        <video id="video" autoplay muted class="w-full h-full object-cover hidden"></video>
                        
                        <!-- Face Detection Overlays -->
                        <div id="detection-overlay" class="absolute inset-0 pointer-events-none hidden">
                            <!-- Dynamic face boxes will be added here -->
                        </div>
                        
                        <!-- Recognition Results Overlay -->
                        <div id="results-overlay" class="absolute bottom-4 left-4 right-4 hidden">
                            <!-- Recognition results will appear here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="xl:col-span-1 space-y-6">
                <!-- Statistics -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4 flex items-center">
                        <i class="fas fa-chart-bar text-primary mr-2"></i>
                        Statistics
                    </h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 bg-primary/5 rounded-lg">
                            <div>
                                <p class="text-sm text-slate-600">Faces Detected</p>
                                <p class="text-2xl font-bold text-primary" id="faces-detected">0</p>
                            </div>
                            <i class="fas fa-search text-primary text-xl"></i>
                        </div>
                        
                        <div class="flex items-center justify-between p-3 bg-emerald-50 rounded-lg">
                            <div>
                                <p class="text-sm text-slate-600">Recognized</p>
                                <p class="text-2xl font-bold text-emerald-600" id="faces-recognized">0</p>
                            </div>
                            <i class="fas fa-check-circle text-emerald-600 text-xl"></i>
                        </div>
                        
                        <div class="flex items-center justify-between p-3 bg-amber-50 rounded-lg">
                            <div>
                                <p class="text-sm text-slate-600">Processing</p>
                                <p class="text-lg font-bold text-amber-600" id="processing-time">0ms</p>
                            </div>
                            <i class="fas fa-clock text-amber-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- System Status -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4 flex items-center">
                        <i class="fas fa-cog text-primary mr-2"></i>
                        System Status
                    </h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-slate-600">Camera</span>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-600">
                                <div class="w-2 h-2 bg-slate-400 rounded-full mr-1"></div>
                                Inactive
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-slate-600">AI Engine</span>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-600">
                                <div class="w-2 h-2 bg-emerald-500 rounded-full mr-1"></div>
                                Ready
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-slate-600">Database</span>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-600">
                                <div class="w-2 h-2 bg-emerald-500 rounded-full mr-1"></div>
                                Connected
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-slate-900 flex items-center">
                            <i class="fas fa-history text-primary mr-2"></i>
                            Recent Activity
                        </h3>
                        <button id="clear-history" class="text-sm text-slate-500 hover:text-slate-700 transition-colors">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div id="recognition-history" class="space-y-2 max-h-64 overflow-y-auto">
                        <div class="text-center text-slate-500 text-sm py-8">
                            <i class="fas fa-clock text-2xl mb-2"></i>
                            <p>No activity yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Notification Container -->
    <div id="message-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        let video, stream;
        let isRunning = false;
        let detectionInterval = null;
        let fpsInterval = null;
        let frameCount = 0;
        let startTime = Date.now();
        
        // Statistics counters
        let totalFacesDetected = 0;
        let totalFacesRecognized = 0;
        let recognitionHistory = [];

        // Status management
        function updateCameraStatus(message, type = 'inactive') {
            const statusElement = document.querySelector('#camera-status span');
            const dot = document.querySelector('#camera-status .w-3');
            
            statusElement.textContent = message;
            
            // Remove existing classes
            dot.classList.remove('bg-slate-400', 'bg-primary', 'bg-emerald-500', 'bg-red-500', 'animate-pulse');
            
            switch(type) {
                case 'active':
                    dot.classList.add('bg-emerald-500', 'animate-pulse');
                    break;
                case 'processing':
                    dot.classList.add('bg-primary', 'animate-pulse');
                    break;
                case 'error':
                    dot.classList.add('bg-red-500');
                    break;
                default:
                    dot.classList.add('bg-slate-400');
            }
        }

        function updateSystemStatus(camera = 'inactive', ai = 'ready', db = 'connected') {
            const statusMap = {
                'active': { class: 'bg-emerald-100 text-emerald-600', dot: 'bg-emerald-500', text: 'Active' },
                'inactive': { class: 'bg-slate-100 text-slate-600', dot: 'bg-slate-400', text: 'Inactive' },
                'error': { class: 'bg-red-100 text-red-600', dot: 'bg-red-500', text: 'Error' },
                'ready': { class: 'bg-emerald-100 text-emerald-600', dot: 'bg-emerald-500', text: 'Ready' },
                'connected': { class: 'bg-emerald-100 text-emerald-600', dot: 'bg-emerald-500', text: 'Connected' }
            };
            
            // Update camera status
            const cameraStatus = document.querySelector('[data-status="camera"]') || 
                document.evaluate("//span[text()='Camera']/following-sibling::span", document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
            if (cameraStatus && statusMap[camera]) {
                cameraStatus.className = `inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusMap[camera].class}`;
                cameraStatus.innerHTML = `<div class="w-2 h-2 ${statusMap[camera].dot} rounded-full mr-1"></div>${statusMap[camera].text}`;
            }
        }

        // Show message function
        function showMessage(message, type = 'info', duration = 5000) {
            const container = document.getElementById('message-container');
            const messageDiv = document.createElement('div');
            
            let bgColor = 'bg-primary';
            let icon = 'fas fa-info-circle';
            
            if (type === 'success') {
                bgColor = 'bg-emerald-600';
                icon = 'fas fa-check-circle';
            } else if (type === 'error') {
                bgColor = 'bg-red-600';
                icon = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                bgColor = 'bg-amber-600';
                icon = 'fas fa-exclamation-triangle';
            }
            
            messageDiv.className = `${bgColor} text-white px-6 py-4 rounded-xl shadow-lg transform transition-transform duration-300 translate-x-full max-w-sm`;
            messageDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="${icon} mr-3 flex-shrink-0"></i>
                    <span class="text-sm font-medium">${message}</span>
                </div>
            `;
            
            container.appendChild(messageDiv);
            
            setTimeout(() => messageDiv.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                messageDiv.classList.add('translate-x-full');
                setTimeout(() => messageDiv.remove(), 300);
            }, duration);
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            video = document.getElementById('video');
            
            document.getElementById('start-camera').addEventListener('click', startCamera);
            document.getElementById('stop-camera').addEventListener('click', stopCamera);
            document.getElementById('clear-history').addEventListener('click', clearHistory);
            document.getElementById('capture-frame').addEventListener('click', captureFrame);
            
            updateCameraStatus('Camera Ready');
        });

        async function startCamera() {
            try {
                updateCameraStatus('Starting camera...', 'processing');
                
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: { ideal: 1280 }, 
                        height: { ideal: 720 },
                        facingMode: 'user'
                    }
                });
                
                video.srcObject = stream;
                isRunning = true;
                
                // Update UI
                document.getElementById('camera-placeholder').classList.add('hidden');
                video.classList.remove('hidden');
                document.getElementById('detection-overlay').classList.remove('hidden');
                document.getElementById('results-overlay').classList.remove('hidden');
                
                document.getElementById('start-camera').classList.add('hidden');
                document.getElementById('stop-camera').classList.remove('hidden');
                document.getElementById('capture-frame').classList.remove('hidden');
                document.getElementById('fps-counter').classList.remove('hidden');
                
                updateCameraStatus('Camera Active - Scanning', 'active');
                updateSystemStatus('active');
                showMessage('Camera started successfully!', 'success');
                
                startDetection();
                startFPSCounter();
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                updateCameraStatus('Camera Access Failed', 'error');
                updateSystemStatus('error');
                showMessage('Could not access camera. Please check permissions.', 'error');
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            isRunning = false;
            
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            
            if (fpsInterval) {
                clearInterval(fpsInterval);
                fpsInterval = null;
            }
            
            // Update UI
            video.classList.add('hidden');
            document.getElementById('detection-overlay').classList.add('hidden');
            document.getElementById('results-overlay').classList.add('hidden');
            document.getElementById('camera-placeholder').classList.remove('hidden');
            
            document.getElementById('stop-camera').classList.add('hidden');
            document.getElementById('capture-frame').classList.add('hidden');
            document.getElementById('start-camera').classList.remove('hidden');
            document.getElementById('fps-counter').classList.add('hidden');
            
            document.getElementById('detection-overlay').innerHTML = '';
            document.getElementById('results-overlay').innerHTML = '';
            
            updateCameraStatus('Camera Stopped');
            updateSystemStatus('inactive');
            showMessage('Camera stopped', 'info');
        }

        function captureFrame() {
            if (!isRunning || !video.videoWidth) return;
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // Create download link
            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `capture_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.jpg`;
                a.click();
                URL.revokeObjectURL(url);
            }, 'image/jpeg', 0.9);
            
            showMessage('Frame captured successfully!', 'success');
        }

        function startDetection() {
            detectionInterval = setInterval(async () => {
                if (!isRunning || !video.videoWidth) return;
                
                try {
                    const startTime = performance.now();
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);
                    
                    canvas.toBlob(async (blob) => {
                        const formData = new FormData();
                        formData.append('image', blob, 'frame.jpg');
                        
                        try {
                            const response = await fetch('/recognize_stream', {
                                method: 'POST',
                                body: formData
                            });
                            
                            const result = await response.json();
                            const endTime = performance.now();
                            const processingTime = Math.round(endTime - startTime);
                            
                            updateProcessingTime(processingTime);
                            displayResults(result);
                            
                        } catch (error) {
                            console.error('Recognition error:', error);
                        }
                    }, 'image/jpeg', 0.8);
                    
                } catch (error) {
                    console.error('Detection error:', error);
                }
            }, 300);
        }

        function startFPSCounter() {
            frameCount = 0;
            startTime = Date.now();
            
            fpsInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                const fps = Math.round(frameCount / elapsed);
                document.getElementById('fps-counter').textContent = `FPS: ${fps}`;
                frameCount++;
            }, 200);
        }

        function displayResults(result) {
            const overlay = document.getElementById('detection-overlay');
            const resultsDiv = document.getElementById('results-overlay');
            
            overlay.innerHTML = '';
            resultsDiv.innerHTML = '';
            
            if (result.faces && result.faces.length > 0) {
                totalFacesDetected += result.faces.length;
                document.getElementById('faces-detected').textContent = totalFacesDetected;
                
                result.faces.forEach((face, index) => {
                    const box = document.createElement('div');
                    box.className = 'absolute border-3 rounded-xl pointer-events-none shadow-lg';
                    
                    if (face.name && face.name !== 'Unknown') {
                        box.classList.add('border-emerald-400', 'bg-emerald-400/20');
                        totalFacesRecognized++;
                        
                        addToHistory(face.name, face.confidence);
                        
                        const label = document.createElement('div');
                        label.className = 'absolute -top-10 left-0 bg-emerald-500 text-white px-3 py-1 text-sm font-medium rounded-lg shadow-md';
                        label.textContent = `${face.name} (${Math.round(face.confidence)}%)`;
                        box.appendChild(label);
                        
                    } else {
                        box.classList.add('border-amber-400', 'bg-amber-400/20');
                        
                        const label = document.createElement('div');
                        label.className = 'absolute -top-10 left-0 bg-amber-500 text-white px-3 py-1 text-sm font-medium rounded-lg shadow-md';
                        label.textContent = 'Unknown Person';
                        box.appendChild(label);
                    }
                    
                    // Simulate face detection positioning
                    const videoRect = video.getBoundingClientRect();
                    const x = Math.random() * (videoRect.width * 0.6) + videoRect.width * 0.2;
                    const y = Math.random() * (videoRect.height * 0.6) + videoRect.height * 0.2;
                    
                    box.style.left = `${x}px`;
                    box.style.top = `${y}px`;
                    box.style.width = '200px';
                    box.style.height = '200px';
                    
                    overlay.appendChild(box);
                });
                
                document.getElementById('faces-recognized').textContent = totalFacesRecognized;
            }
        }

        function addToHistory(name, confidence) {
            const timestamp = new Date().toLocaleTimeString();
            recognitionHistory.unshift({ name, confidence, timestamp });
            
            if (recognitionHistory.length > 15) {
                recognitionHistory = recognitionHistory.slice(0, 15);
            }
            
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const historyDiv = document.getElementById('recognition-history');
            
            if (recognitionHistory.length === 0) {
                historyDiv.innerHTML = `
                    <div class="text-center text-slate-500 text-sm py-8">
                        <i class="fas fa-clock text-2xl mb-2"></i>
                        <p>No activity yet</p>
                    </div>
                `;
                return;
            }
            
            historyDiv.innerHTML = recognitionHistory.map(entry => `
                <div class="flex items-center justify-between py-3 px-4 bg-slate-50 rounded-lg border border-slate-200">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-primary to-secondary rounded-full flex items-center justify-center text-white font-bold text-sm">
                            ${entry.name[0].toUpperCase()}
                        </div>
                        <div>
                            <div class="font-medium text-slate-900 text-sm">${entry.name}</div>
                            <div class="text-xs text-slate-500">${entry.timestamp}</div>
                        </div>
                    </div>
                    <div class="text-xs font-medium text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full">
                        ${Math.round(entry.confidence)}%
                    </div>
                </div>
            `).join('');
        }

        function clearHistory() {
            recognitionHistory = [];
            totalFacesDetected = 0;
            totalFacesRecognized = 0;
            
            document.getElementById('faces-detected').textContent = '0';
            document.getElementById('faces-recognized').textContent = '0';
            
            updateHistoryDisplay();
            showMessage('Activity history cleared', 'info');
        }

        function updateProcessingTime(time) {
            document.getElementById('processing-time').textContent = `${time}ms`;
        }

        window.addEventListener('beforeunload', function() {
            stopCamera();
        });
    </script>
</body>
</html>